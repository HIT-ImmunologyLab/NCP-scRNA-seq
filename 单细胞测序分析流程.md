## 单细胞测序分析流程
### 基础流程
**Workflow** 如图所示：

![example-workflow](https://github.com/fengxiaZhou/NCP-scRNA-seq/raw/master/images/example-workflow.png)

CellRanger安装使用，结果解读，详见Cell Ranger文档（https://github.com/hitzhangfan/NCP-scRNA-seq/blob/master/Cell%20Ranger.md）。
#### cellranger 数据拆分
 mkfastq可用于将单细胞测序获得的 BCL 文件拆分为可以识别的 fastq 测序数据

```
cellranger makefastq   --run=[ ]   --samplesheet=[sample.csv] --jobmode=local --localcores=20 --localmem=80
```

```
-–run ：是下机数据 BCL 所在的路径；
-–samplesheet ：样品信息列表--共三列（lane id ,sample name ,index name)
```
#### cellranger 数据统计
cellranger count是 cellranger 最主要也是最重要的功能：完成细胞和基因的定量，也就是产生了我们用来做各种分析的基因表达矩阵。

```
cellranger count \
-–id=sample345 \
-–transcriptome=/opt/refdata-cellranger-GRCh38-1.2.0/GRCh38 \
-–fastqs=/home/jdoe/runs/HAWT7ADXX/outs/fastq_path \
-–indices=SI-3A-A1 \
–-cells=1000
```

```
id ：产生的结果都在这个文件中，可以取几号样品（如 sample345）；

fastqs ：由 cellranger mkfastq 产生的 fastqs 文件夹所在的路径；

indices：sample index：SI-3A-A1；

transcriptome：参考转录组文件路径；

cells：预期回复的细胞数；
```
### 下游分析
cellranger count 计算的结果只能作为初步观测的结果，如果需要进一步分析聚类细胞，还需要进行下游分析，这里使用官方推荐 R 包（Seurat）

Seurat 的安装，使用，结果分析详见Seurat文档


## 伪时间分析
伪时间分析建议采用 monocle3.0 软件
### 软件安装
```{r}
##安装依赖
BiocManager::install(c('BiocGenerics','DelayedArray', 'DelayedMatrixStats','limma', 'S4Vectors', 'SingleCellExperiment','SummarizedExperiment', 'batchelor'))
##安装monocle3
devtools::install_github('cole-trapnell-lab/leidenbase')
devtools::install_github('cole-trapnell-lab/monocle3')
library(monocle3)
```
### 标准分析流
```{r}
library(Seurat)
library(monocle3)
endo<-readRDS("../output/pbmc_tutorial.rds")
data <- endo@assays$RNA@counts
pd <-  endo@meta.data
```
不要直接把meta.data放入pd中去，太多没用的信息了，先清理下
```{r}
new_pd<-select(pd,nCount_RNA,nFeature_RNA,percent.mt)
new_pd$Cell.type<-Idents(endo)
head(new_pd)
                      nCount_RNA nFeature_RNA percent.mt
AAACCTGGTATCAGTC-1_1      4835         1383   3.536711
AACCGCGCATTCCTGC-1_1      4029         1230   2.655746
AACGTTGAGCCCAATT-1_1      2576          918   3.377329
AAGACCTGTGGTTTCA-1_1      2841         1044   5.455825
AAGTCTGCATGAAGTA-1_1      3731         1213   3.886358
ACAGCCGCATCGGACC-1_1      5915         1918   3.043111
                                     Cell.type
AAACCTGGTATCAGTC-1_1                       DC2
AACCGCGCATTCCTGC-1_1                      MDSC
AACGTTGAGCCCAATT-1_1                      MDSC
AAGACCTGTGGTTTCA-1_1 Dendritic.cells.activated
AAGTCTGCATGAAGTA-1_1                      MDSC
ACAGCCGCATCGGACC-1_1 Dendritic.cells.activated

fData <- data.frame(gene_short_name = row.names(data), row.names = row.names(data))
```
生成monocle的cds对象
```{r}
cds <- new_cell_data_set(data,cell_metadata  = new_pd,gene_metadata  = fData)
```
运行下游标准流程，无论如何都得跑，是必须的默认流程
```{r}
cds <- preprocess_cds(cds, num_dim = 30)
#umap
cds <- reduce_dimension(cds,umap.n_neighbors = 20L)
#color by seurat cluster
plot_cells(cds,label_groups_by_cluster=FALSE,color_cells_by = "Cell.type")
```
![markdown](https://github.com/ccgBiotechLover/single-cell-course/raw/master/monocle%20figures/fig10.webp "markdown")
图 10：undefined
```{r}
#cluster
cds <- cluster_cells(cds,resolution = 0.5)
#color by monocle cluster
plot_cells(cds, color_cells_by = "partition",label_groups_by_cluster=FALSE)
```
![markdown](https://github.com/ccgBiotechLover/single-cell-course/raw/master/monocle%20figures/fig11.webp "markdown")
图 11：undefined
```{r}
cds <- learn_graph(cds)
plot_cells(cds,color_cells_by = "Cell.type",label_groups_by_cluster=FALSE,label_leaves=TRUE,label_branch_points=TRUE)
```
![markdown](https://github.com/ccgBiotechLover/single-cell-course/raw/master/monocle%20figures/fig12.webp "markdown")
图 12：undefined
### 定义时间开始节点&&伪时间分析
```{r}
##一个有用的寻找起源节点的函数
get_earliest_principal_node <- function(cds, time_bin="Dendritic.cells.activated"){
  cell_ids <- which(colData(cds)[, "Cell.type"] == time_bin)
  closest_vertex <-
  cds@principal_graph_aux[["UMAP"]]$pr_graph_cell_proj_closest_vertex
  closest_vertex <- as.matrix(closest_vertex[colnames(cds), ])
  root_pr_nodes <-
  igraph::V(principal_graph(cds)[["UMAP"]])$name[as.numeric(names
  (which.max(table(closest_vertex[cell_ids,]))))]
  root_pr_nodes
}

#order cell
cds <- order_cells(cds, root_pr_nodes=get_earliest_principal_node(cds))
#pseudotime analysis
plot_cells(cds,color_cells_by = "pseudotime",label_cell_groups=FALSE,label_leaves=FALSE,label_branch_points=FALSE,graph_label_size=1.5)
```
![markdown](https://github.com/ccgBiotechLover/single-cell-course/raw/master/monocle%20figures/fig13.webp "markdown"）
PS:对多样本进行伪时间分析，请参考[使用Monocle3对多样本单细胞数据进行伪时间分析](https://www.hongguangblog.cn/archives/48/ "普通链接带标题")
其他教程链接：
[整合刺激性和对照性PBMC数据集，以学习细胞类型特异性反应](https://www.hongguangblog.cn/archives/79/ "普通链接带标题")
[10X单细胞数据针对细胞及其亚型的基因集功能分析和转录调控分析](https://www.hongguangblog.cn/archives/13/ "普通链接带标题")
Reference:<https://www.hongguangblog.cn/archives/6/>

